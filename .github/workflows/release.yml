name: Release DMG

on:
  push:
    branches: [ main ]
    paths:
      - VERSION
      - CHANGELOG.md
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  SWIFT_BUILD_PATH: ${{ github.workspace }}/.build-local
  CLANG_MODULE_CACHE_PATH: ${{ github.workspace }}/.build-local/clang-module-cache
  SWIFTPM_MODULECACHE_OVERRIDE: ${{ github.workspace }}/.build-local/clang-module-cache

jobs:
  validate:
    runs-on: macos-15
    outputs:
      should_release: ${{ steps.version.outputs.should_release }}
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      latest_tag: ${{ steps.version.outputs.latest_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Select Xcode (Swift 6.2+)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Verify toolchain
        run: |
          set -euo pipefail
          xcodebuild -version
          swift --version
          swift -e 'import Foundation; print("swift-ok")'

      - name: Validate changed files for push trigger
        if: github.event_name == 'push'
        run: |
          set -euo pipefail
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"
          CHANGED="$(git diff --name-only "$BEFORE" "$AFTER" || true)"
          echo "$CHANGED"

          echo "$CHANGED" | grep -qx "VERSION" || {
            echo "Push must include VERSION changes." >&2
            exit 1
          }
          echo "$CHANGED" | grep -qx "CHANGELOG.md" || {
            echo "Push must include CHANGELOG.md changes." >&2
            exit 1
          }

      - name: Resolve version and release decision
        id: version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          if [[ ! -f VERSION ]]; then
            echo "VERSION file is missing" >&2
            exit 1
          fi

          VERSION="$(tr -d '[:space:]' < VERSION)"
          if [[ -z "$VERSION" ]]; then
            echo "VERSION is empty" >&2
            exit 1
          fi
          if [[ ! "$VERSION" =~ ^[0-9]+(\.[0-9]+){2}$ ]]; then
            echo "VERSION must follow semantic format MAJOR.MINOR.PATCH" >&2
            exit 1
          fi

          if [[ ! -f CHANGELOG.md ]]; then
            echo "CHANGELOG.md file is missing" >&2
            exit 1
          fi
          if ! grep -Eq "^## \[$VERSION\]( |$)" CHANGELOG.md; then
            echo "CHANGELOG.md must contain section header: ## [$VERSION]" >&2
            exit 1
          fi

          TAG="v$VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

          LATEST_TAG="$(gh release list --limit 1 --json tagName --jq '.[0].tagName // ""' || true)"
          echo "latest_tag=$LATEST_TAG" >> "$GITHUB_OUTPUT"

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists. Immutable policy: skip." >&2
            echo "should_release=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ -z "$LATEST_TAG" ]]; then
            echo "No releases found; will create first release."
            echo "should_release=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          SHOULD_RELEASE="$(python3 - <<'PY' "$VERSION" "$LATEST_TAG"
          import re
          import sys

          new_version = sys.argv[1].strip()
          latest_tag = sys.argv[2].strip()
          latest_version = latest_tag[1:] if latest_tag.startswith("v") else latest_tag

          def parse(v: str):
              if not re.fullmatch(r"\d+\.\d+\.\d+", v):
                  return None
              return tuple(map(int, v.split(".")))

          n = parse(new_version)
          l = parse(latest_version)
          if n is None or l is None:
              print("false")
          else:
              print("true" if n > l else "false")
          PY
          )"

          echo "should_release=$SHOULD_RELEASE" >> "$GITHUB_OUTPUT"
          if [[ "$SHOULD_RELEASE" == "false" ]]; then
            echo "Version $VERSION is not greater than latest $LATEST_TAG; skipping release."
          fi

  lint:
    runs-on: macos-15
    needs: validate
    if: needs.validate.outputs.should_release == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode (Swift 6.2+)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Lint manifests and scripts
        run: |
          set -euo pipefail
          mkdir -p "$SWIFT_BUILD_PATH" "$CLANG_MODULE_CACHE_PATH"
          swift package dump-package >/dev/null
          swift package describe >/dev/null
          bash -n scripts/package_dmg.sh

  test:
    runs-on: macos-15
    needs: [validate, lint]
    if: needs.validate.outputs.should_release == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode (Swift 6.2+)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Run unit tests
        run: |
          set -euo pipefail
          mkdir -p "$SWIFT_BUILD_PATH" "$CLANG_MODULE_CACHE_PATH"
          swift test --build-path "$SWIFT_BUILD_PATH"

      - name: Run behavior tests
        run: |
          set -euo pipefail
          swift run --build-path "$SWIFT_BUILD_PATH" KubeconfigEditorBehaviorTests

  release:
    runs-on: macos-15
    needs: [validate, lint, test]
    if: needs.validate.outputs.should_release == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode (Swift 6.2+)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build DMG
        run: |
          set -euo pipefail
          chmod +x ./scripts/package_dmg.sh
          ./scripts/package_dmg.sh

      - name: Build release notes from changelog
        id: notes
        run: |
          set -euo pipefail
          VERSION="${{ needs.validate.outputs.version }}"
          NOTES_FILE="release-notes.md"
          python3 - <<'PY' "$VERSION" "$NOTES_FILE"
          import re
          import sys
          from pathlib import Path

          version = sys.argv[1]
          out = Path(sys.argv[2])
          text = Path("CHANGELOG.md").read_text(encoding="utf-8")
          pattern = re.compile(rf"^## \[{re.escape(version)}\].*$", re.MULTILINE)
          m = pattern.search(text)
          if not m:
              raise SystemExit(f"Missing changelog section for version {version}")

          start = m.end()
          next_header = re.search(r"^## \[", text[start:], re.MULTILINE)
          body = text[start: start + next_header.start()] if next_header else text[start:]
          body = body.strip()
          if not body:
              body = f"Release {version}"
          out.write_text(body + "\n", encoding="utf-8")
          PY
          echo "file=$NOTES_FILE" >> "$GITHUB_OUTPUT"

      - name: Publish immutable GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          VERSION="${{ needs.validate.outputs.version }}"
          TAG="${{ needs.validate.outputs.tag }}"
          DMG_PATH="dist/KubeconfigEditor-${VERSION}.dmg"

          if [[ ! -f "$DMG_PATH" ]]; then
            echo "DMG not found: $DMG_PATH" >&2
            exit 1
          fi

          gh release create "$TAG" "$DMG_PATH" \
            --title "$TAG" \
            --notes-file "${{ steps.notes.outputs.file }}"
